version: '3'

tasks:
  build:
    desc: Build the CLI binary
    cmds:
      - go build -o bin/codebase-interface ./cmd/codebase-interface
      - cd bin && ln -sf codebase-interface cbi

  test:
    desc: Run all tests
    cmds:
      - go test ./...

  test:watch:
    desc: Run tests in watch mode
    deps: [install-gotestsum]
    cmds:
      - gotestsum --watch

  lint:
    desc: Run linting
    deps: [install-golangci-lint]
    cmds:
      - golangci-lint run

  tidy:
    desc: Tidy Go modules
    cmds:
      - go mod tidy

  install:
    desc: Install CLI locally
    cmds:
      - go install ./cmd/codebase-interface

  build:all:
    desc: Build binaries for all platforms
    cmds:
      - mkdir -p bin/releases
      - GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o bin/releases/codebase-interface-linux-amd64 ./cmd/codebase-interface
      - GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o bin/releases/codebase-interface-darwin-amd64 ./cmd/codebase-interface
      - GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o bin/releases/codebase-interface-darwin-arm64 ./cmd/codebase-interface
      - GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o bin/releases/codebase-interface-windows-amd64.exe ./cmd/codebase-interface
      - echo "âœ… Built binaries for all platforms in bin/releases/"

  package:
    desc: Package binaries for distribution
    deps: [build:all]
    cmds:
      - cd bin/releases && tar -czf codebase-interface-linux-amd64.tar.gz codebase-interface-linux-amd64
      - cd bin/releases && tar -czf codebase-interface-darwin-amd64.tar.gz codebase-interface-darwin-amd64
      - cd bin/releases && tar -czf codebase-interface-darwin-arm64.tar.gz codebase-interface-darwin-arm64
      - cd bin/releases && zip codebase-interface-windows-amd64.zip codebase-interface-windows-amd64.exe
      - echo "ğŸ“¦ Packaged binaries for distribution"

  release:prepare:
    desc: Prepare release artifacts
    deps: [test, lint, package]
    cmds:
      - echo "ğŸš€ Release artifacts prepared in bin/releases/"

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf bin/

  setup:
    desc: Set up development environment
    deps: [install-gotestsum, install-golangci-lint, docs:install]
    cmds:
      - go mod download

  install-gotestsum:
    desc: Install gotestsum for test watching
    cmds:
      - go install gotest.tools/gotestsum@latest
    status:
      - which gotestsum

  install-golangci-lint:
    desc: Install golangci-lint for linting
    cmds:
      - go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
    status:
      - which golangci-lint

  validate-self:
    desc: Run the CLI on itself for validation
    deps: [build]
    cmds:
      - ./bin/codebase-interface validate

  dev:
    desc: Development workflow - build and test
    deps: [build, test]

  docs:serve:
    desc: Serve documentation using MkDocs
    cmds:
      - |
        echo "ğŸ“š Serving documentation with MkDocs at http://localhost:8000"
        echo "Press Ctrl+C to stop the server"
        mkdocs serve

  docs:build:
    desc: Build static documentation site
    cmds:
      - mkdocs build
      - echo "ğŸ“¦ Documentation built in site/ directory"

  docs:open:
    desc: Serve documentation and open in browser
    cmds:
      - |
        echo "ğŸš€ Starting MkDocs server and opening browser..."
        (sleep 3 && (
          if command -v xdg-open > /dev/null 2>&1; then
            xdg-open http://localhost:8000
          elif command -v open > /dev/null 2>&1; then
            open http://localhost:8000
          else
            echo "Please open http://localhost:8000 in your browser"
          fi
        )) &
        mkdocs serve

  docs:install:
    desc: Install MkDocs and required plugins
    cmds:
      - pip install mkdocs mkdocs-material mkdocs-git-revision-date-localized-plugin
      - echo "ğŸ“š MkDocs installed successfully"

  docs:check:
    desc: Check documentation for common issues (links, formatting)
    cmds:
      - |
        echo "ğŸ” Checking documentation..."
        find docs/ -name "*.md" -exec echo "Checking {}" \; -exec grep -l "TODO\|FIXME\|XXX" {} \; || true
        echo "âœ… Documentation check complete"

  docker:build:
    desc: Build Docker image locally
    cmds:
      - docker build -t ghcr.io/codebase-interface/cli:dev .
      - echo "ğŸ³ Docker image built successfully"

  docker:test:
    desc: Test Docker image functionality
    deps: [docker:build]
    cmds:
      - docker run --rm ghcr.io/codebase-interface/cli:dev --help
      - docker run --rm -v $(pwd):/workspace ghcr.io/codebase-interface/cli:dev validate-config
      - echo "âœ… Docker image tests passed"

  install:test:
    desc: Test installation script (dry run)
    cmds:
      - echo "ğŸ§ª Testing installation script syntax..."
      - bash -n install.sh
      - echo "âœ… Installation script syntax is valid"

  release:check:
    desc: Check if ready for release
    deps: [test, lint, build:all, docker:test]
    cmds:
      - echo "ğŸš€ Release readiness check complete"
      - echo "âœ… All tests passed"
      - echo "âœ… Linting passed"
      - echo "âœ… Cross-platform builds successful"
      - echo "âœ… Docker image functional"